\input{preamble.tex}


\begin{document}

\input{class_lecture_firstslide.tex}

\scriptsize

\begin{frame}[fragile]
\frametitle{{\Red \CLASS{}} in \location}

\mbox{}\\\mbox{}\\
What to expect in these lectures:
\vspace*{0.5\baselineskip}\mbox{}
\bgroup 
\def\arraystretch{1.15}
\begin{tabular}{lll}
$\bullet$&Basics:& Why use {\Red \CLASS{}}?\\
$\bullet$&Usage:& Installation\\
$\bullet$&Usage:& Python Interface \\
$\bullet$&Basics:& Existing Species \\
$\bullet$&Basics:& Module Overview \\
$\bullet$&Theory:& What is {\Red \tt class} based upon?\\
$\bullet$&Coding:& Implementing features
\end{tabular}
\egroup

\mbox{}\\
We will learn {\Red how to use \CLASS{}} and {\Red which models} can be run with it.\\\mbox{}\\
\begin{center}\includegraphics[width=8cm,angle=0]{Figures/logo-ecole-300.png}\end{center}

\end{frame}

% \begin{frame}[fragile]
% \frametitle{{\Red \CLASS{}} Theory}

% \begin{enumerate}
% 	\item Fundamental layout of Einstein-Boltzmann solvers
% 	\item Essential steps for each module
% 	\item A few details for each of these steps
% \end{enumerate}

% \end{frame}

\begin{frame}[fragile]
	\frametitle{Fundamental layout of Einstein-Boltzmann solvers}
	\begin{tikzpicture}[
	start chain=going below,
	every join/.style={arrow,color=black},
	node distance=0.6cm
	]
	\node (bg) [process,on chain,join] {Homogeneous background\\
		$H(a),\rho_i(a),D(a),...$};
	\begin{scope}[start branch]
	\node (th) [process,on chain=going right,join] {Homogeneous thermodynamics\\
		$x_e(z),T_b(z),c_s(z),...$};
	\end{scope}
	\pause
	\draw[tuborg] let
	\p1=(th.north east), \p2=(th.south east) in
	($(\x1+0.5em,\y1)$) -- ($(\x2+0.5em,\y2)$) node[right,midway,xshift=2pt]  {Unify (?)};
	\pause
	\node (pt) [process,on chain,join] {Perturbations\\$\delta_i(k,\tau),\theta_i(k,\tau),...$};
	\begin{scope}[start branch]
	\node (pm) [process,on chain=going right,xshift=4.5em] {Initial condition\\ $P_\mathcal{R}(k)$};
	\end{scope}
	\draw[arrow,color=black] (pm) -- (pt) node[pos=0.4,cross=5pt,sloped] {};
	\draw[arrow,color=red] (pm) -- (pt) node[pos=0.48,sloped,label={[label distance=0.2em,color=red]270:Not required}] {};
	\pause
	\node (obs) [startstop,on chain,join] {Projection\\(LoS/fixed-time)};
	\node (sp) [process,on chain,join] {Correlation functions\\
		$P(k,z),C_\ell$};
	\draw[arrow,color=ForestGreen] (pm) |- (0pt,-70pt) -- (obs.north);
	\draw[arrow,color=black] (th.south) |- (60pt,-25pt)|- (pt.east);
	
	\pause \node [process, below=0mm of bg.north, anchor=north,fill=RWTHbordeaux,text=white] {Background module\\ \texttt{background.c}};
	\pause \node [process, below=0mm of th.north, anchor=north,fill=RWTHbordeaux,text=white] {Thermodynamics module\\ \texttt{thermodynamics.c}};
	\pause \node [process, below=0mm of pt.north, anchor=north,fill=RWTHbordeaux,text=white] {Perturbations module\\ \texttt{perturbations.c}};
	\pause \node [process, below=0mm of pm.north, anchor=north,fill=RWTHbordeaux,text=white] {Primordial module\\ \texttt{primordial.c}};
	\pause \node [startstop, below=0mm of obs.north, anchor=north,fill=RWTHbordeaux,text=white] {Transfer module\\ \texttt{transfer.c}};
	\pause \node [process, below=0mm of sp.north, anchor=north,fill=RWTHbordeaux,text=white] {Harmonic module \& Fourier module\\ \texttt{harmonic.c , fourier.c}};
	\pause \node [process, on chain, join,fill=RWTHbordeaux,text=white] {Lensing module \\ \texttt{lensing.c}};
	\pause \node [process, on chain=going right,fill=RWTHbordeaux,text=white] {Distortions module \\ \texttt{distortions.c}};
	\pause \node [process, on chain=going right,fill=RWTHbordeaux,text=white] {Input \& Output module \\ \texttt{input.c , output.c}};
	\onslide<1->
	\end{tikzpicture}
\end{frame}

\begin{frame}[fragile]
\frametitle{Essential steps in Einstein-Boltzmann solver}
{\centering \Large Let's make a journey through each module!}
\end{frame}

% \section{Modules}



%%%%%%%%%%%%%%%%%%% Thermodynamics


\begin{frame}[fragile]
\frametitle{Essentials 3: Thermodynamics}

\mbox{}\\
Get all thermodynamics quantities as function of a time variable ({\Red \CLASS{}} $\rightarrow$ redshift $z$) after integrating differential equations like recombination equations:
$$
\frac{d x_e}{dz} , \frac{d T_b}{dz}= {\rm excitation}, {\rm ionization}, {\rm heating}, ... 
$$
\vspace{-0.5cm}\\
{\centering
\includegraphics[width=5cm,angle=0]{Figures/xe.pdf}\\}
Then $x_e(z) \rightarrow \kappa'(z)$ (Thomson scattering rate)\\
~~~~~~~~~~~~~~~$\rightarrow \kappa(z)$ (Optical depth)\\
~~~~~~~~~~~~~~~$\rightarrow \exp(-\kappa(z))$ (factor for Integrated Sachs-Wolfe effect)\\
~~~~~~~~~~~~~~~$\rightarrow g(z)$ (visibility function for Sachs-Wolfe effect)\\
~~~~~~~~~~~~~~~$\rightarrow g'(z)$ (factor for Doppler effect)\\

\end{frame}


\begin{frame}[fragile]
	\frametitle{The Thermodynamics Module}
	
	Simplest model of {\Red recombination} is the {\Red Saha equation}.\\ \mbox{}\\ 
	
	It is well known that a non-relativistic ($T \ll m$) species in thermal equilibrium obeys
	\begin{equation}
		n(\mu,T) \approx g e^{\mu/T} \left(\frac{m T}{2 \pi}\right)^{3/2} e^{-m/T}
	\end{equation}
	
	Thus we find using {\Red complete thermal equilibrium} with $\mu_\mathrm{ionized} + \mu_e = \mu_\mathrm{rec}$ that
	\begin{equation*}
		\frac{n_e n_\mathrm{ionized}}{n_\mathrm{rec}} \approx {\Red \left(\frac{m_e T}{2\pi}\right)^{3/2} e^{-E_\mathrm{bind}/T}} \times \underbrace{\left[ e^{\mu_\mathrm{ionized} + \mu_e - \mu_\mathrm{rec}} \left(\frac{g_e g_\mathrm{ionized}}{g_\mathrm{rec}}\right) \left(\frac{m_\mathrm{ionized}}{m_\mathrm{rec}}\right)^{3/2}\right]}_{\approx 1}
	\end{equation*}
	\vspace*{-2\baselineskip}
	This gives
	\begin{equation}
		\frac{x_e^2}{1-x_e} \approx \left(\frac{1.1 \cdot 10^{-10}}{n_\mathrm{H,0} /T_\mathrm{cmb,0}^3}\right) \left(\frac{\mathrm{eV}}{T}\right)^{3/2} {\Red \exp(39.9 - 13.6 \frac{\mathrm{eV}}{T})}
	\end{equation}
	and thus recombination at $T \approx \frac{13.6\mathrm{eV}}{39.9} \approx 0.34\mathrm{eV}$ $\to z \approx 1400$. \pause This is of course wrong...\\ \pause
	{\Red recombination is a non-equilibrium process}
\end{frame}


\begin{frame}[fragile]
\frametitle{The Thermodynamics Module}

The {\Red effective multi-level atom} is the basis for recombination codes.\\ \mbox{}\\

1s 2s 2p 3s 3p 3d ... ionized $\to$ 1s 2s 2p ionized \\ \mbox{}\\

\pause
Reason: Intermediate transitions (4p$\to$3s) or (3s$\to$2p) are comparatively instant. Why? Direct transition $2s \to 1s$ is forbidden, and $2p \to 1s$ is immediately reversed by $1s \to 2p$. The medium is {\Red optically thick} during recombination.\\ \mbox{}\\

\pause
Instead, focus on $2p \to 1s$ with subsequent redshifting of photon to escape reabsorption (slow) or $2s \to 1s$ with two-photon decay (slow). \\ \mbox{}\\

{\Red Peeble's equation}
\begin{equation}
	\dot{x_e} \approx f_\mathrm{photo-ion}(T) x_\mathrm{rec}-f_\mathrm{rec}(T) x_e x_\mathrm{ionized} 
\end{equation}
Solved numerically, basis of {\Red recfast}
\end{frame}



\begin{frame}[fragile]
	\frametitle{The Thermodynamics Module}
	
	{\Red recfast} only resolves $2s \approx 2p$\\ \mbox{}\\
	\pause
	Improvement: {\Red HyRec} with EMLA resolves $2s,2p$. Even more, can do $2s,2p,3s,...$ with \textit{effective} rates.\\ \mbox{}\\
	
	Fullest code to date: {\Red CosmoRec} does full numerical computation (iteratively). Comparatively slow, but highest achievable accuracy\\ \mbox{}\\
	
	\pause
	Further complication: Helium (higher elements don't contribute)\\
	{\centering\includegraphics[width=5cm,angle=0]{Figures/xe.pdf}\\}
\end{frame}


\begin{frame}[fragile]
\frametitle{The Thermodynamics Module}

User can choose to model approximate recombination and get $x_e(z)$, $T_b(z)$ from:
\begin{itemize}
\item {\Purple RECFAST} (Wong, Moss \& Scott 2008)
\item {\Purple HyRec-2} (Y. Ali-Ha\"{\i}moud, N. Lee)
\item Possibly soon? {\Purple CosmoRec} (J. Chluba)
\end{itemize}

\pause
\vspace{0.2cm}

Recombination needs one more cosmological parameter: the {\Red primordial Helium fraction} $Y_\mathrm{He}$.
\begin{itemize}
\item Fix it (\cinline{Y_He = 0.25})
\item Get it from BBN (\cinline{Y_He = BBN}). {\Red \CLASS{}} has interpolation table pre-pcomputed with a {\Red BBN code} ({\Purple Parthenope}), for each given value of $N_\mathrm{eff}$, $\omega_b$ (assumes $\mu_{\nu_e}=0$, easy to generalize).
\item BBN interpolation table located in separate directory (in \cinline{external/bbn/sBBN_2017.dat}, update inbound)
\end{itemize}


\mbox{}\\

\end{frame}


\begin{frame}[fragile]
	\frametitle{The Thermodynamics Module}
	
	For reionization:
	\begin{itemize}
		\item tanh with complicated argument (like {\tt \Red CAMB})
		\item multi-tanh
		\item half tanh
		\item from file (either linear or tanh)
	\end{itemize}
	
	\pause 
	\vspace{0.2cm}
	Mini-shooting to find $z_\mathrm{reio}$ for given $\tau_\mathrm{reio} = \kappa_\mathrm{reio}$. 
	
	Optical depth $\kappa(z)$ = inverse number of expected interactions  $\Rightarrow \kappa'(z) = a n_H x_e \sigma_T$\\
	% \includegraphics[width=5cm,angle=0]{Figures/thermo_kappa.pdf}\includegraphics[width=5cm,angle=0]{Figures/thermo_kappa_integrated.pdf}\\
\end{frame}


\begin{frame}[fragile]
	\frametitle{The Thermodynamics Module}

	We also include
	\begin{itemize}
		\item Energy injection (increases ionization, heats $T_b$)

		This can cause changes in scattering $\kappa(z)$ and thus be observable with CMB
		\item Time-dependent fundamental constants $\to$ Causes shift in recombination due to fundamental dependencies such as $E_\mathrm{binding} = \frac{1}{2}\alpha^2 m_e= 13.6\mathrm{eV} \left(137 \alpha\right)^2 \left(\frac{m_e}{511\mathrm{keV}}\right)$
		\\
		We remind ourselves $1+z_\mathrm{rec} = T_\mathrm{rec}/T_\mathrm{cmb} \approx \frac{E_\mathrm{binding}}{12.57\mathrm{meV}}$
		\item Computation of useful quantities $z_\mathrm{rec}, z_\mathrm{drag}, z_*, D_A(z_\mathrm{rec}), r_s(z_\mathrm{drag}), ...$
	\end{itemize}
\end{frame}

\begin{frame}[fragile]
	\frametitle{Thermodynamics exercise}
Let's check this with an exercise!

Download the jupyter notebook \href{https://github.com/MarkMos/class_lecture/blob/main/notebooks/Exercise_thermodynamics_to_fill.ipynb}{Exercise\_thermodynamics\_to\_fill.ipynb} and follow the steps to plot the properties computed by the Thermodynamics module.


\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%% Perturbations


\begin{frame}[fragile]
	\frametitle{Essentials 4: Perturbations}
	
	\mbox{}\\
	\begin{itemize}
		\item
		Find all perturbations ($\delta_X(\tau,k)$, $\phi(\tau,k)$, ...)  by integrating ODEs for each independent wavenumber $k$, each mode (scalar/tensor), each initial condition (adiabatic/isocurvature)\\
		{\centering\includegraphics[width=8cm]{Figures/BoltzmannDiagram.pdf}\\}
		\vspace*{-5\baselineskip}\hspace*{-1em}
		{\Red Minimal set!} (no massive neutrinos, or advanced DM/DE)
	\end{itemize}
\end{frame}


\begin{frame}[fragile]
	\frametitle{The Perturbations Module}
	
	\begin{itemize}
		\item
		Find all perturbations ($\delta_X(\tau,k)$, $\phi(\tau,k)$, ...)  by integrating ODEs for each independent wavenumber $k$, each mode (scalar/tensor), each initial condition (adiabatic/isocurvature):
		\begin{itemize}
			\item \scriptsize Boltzmann
			\item  \scriptsize Continuity + Euler
			\item \scriptsize linearized Einstein equations (one = ODE, others = constraint equations)
			
			\mbox{}\\
			
		\end{itemize}
		Linear perturbations $\Rightarrow$ perturbations normalized to initial condition \\
		({\Red \CLASS{}} $\rightarrow$ curvature ${\cal R}=1$ for scalar with adiabatic I.C.)
	\end{itemize}
\end{frame}

\begin{frame}[fragile]
	\frametitle{The Perturbations Module}
	
	Einstein Equations
	\begin{align}
		k^2 \phi + 3\mathcal{H} (\phi'+\mathcal{H}\psi) &= -4\pi G a^2 \delta \rho\\
		k^2 (\phi'+\mathcal{H}\psi) &= 4\pi G a^2 (\rho+P) \theta
		\phi''+\mathcal{H}\\ (\psi'+\phi')+(2\mathcal{H}'+\mathcal{H}^2) \psi + \frac{1}{3}k^2 (\phi-\psi) &= 4\pi G a^2 \delta P\\
		k^2 (\phi-\psi) = 12\pi G a^2 (\rho+P) \sigma
	\end{align}
	
	and Boltzmann equations
	\begin{align}
		\frac{\mathrm{d}F_0^{(\gamma)}}{\mathrm{d}\eta} + k F_1^{(\gamma)} &= 4\phi'\\
		\frac{\mathrm{d}F_1^{(\gamma)}}{\mathrm{d}\eta} - \frac{k}{3} \left[F_0^{(\gamma) - 2 F_2^{(\gamma)}}\right] &= \frac{4 k}{3} \psi + \underbrace{\Gamma_{\gamma,b}}_\text{from thermodynamics} [F_1^{(b)}-F_1^{(\gamma)}]\\
		\frac{\mathrm{d}F_2^{(\gamma)}}{\mathrm{d}\eta} - \frac{k}{5} \left[2 F_1^{(\gamma) - 3 F_3^{(\gamma)}}\right] &= \underbrace{\Gamma_{\gamma,b}}_\text{from thermodynamics} [-F_2^{(\gamma)}+\Pi^\mathrm{pol}/10]\\
		\frac{\mathrm{d}F_\ell^{(\gamma)}}{\mathrm{d}\eta} - \frac{k}{2\ell+1} \left[\ell F_{\ell-1}^{(\gamma) - (\ell+1) F_{\ell+1}^{(\gamma)}}\right] &= 0 \qquad \qquad \text{(infinite hierarchy)}
	\end{align}
\end{frame}

\begin{frame}[fragile]
	\frametitle{The Perturbations Module}
	
	4 Einstein Equations (only one dynamical)\\
	1 $\ell^{(\gamma)}_{\rm max}$ photon temperature hierarchy \\
	1 $\ell^{(\gamma)}_{\rm max}$ photon polarization hierarchy (or 2 $\ell^{(\gamma)}_{\rm max}$) \\
	2 baryon (density, velocity) \\
	1/2 cdm equations (density?, velocity)\\
	Either
	\begin{itemize}
		\item[a)] 1 $\ell^{\mathrm{(dr)}}_{\rm max}$ massless neutrino hierarchy
		\item[b)] 1 $\ell^{\mathrm{(dr)}}_{\rm max}$ massless neutrino hierarchy \\+ $N_\mathrm{ncdm} \cdot \ell^{\mathrm{(ncdm)}}_{\rm max} \cdot N_q$ massive neutrino hierarchies
	\end{itemize}
	\mbox{}\\ \mbox{}\\
	= Too many equations for simple solvers!\\
	(also tight coupling == stiff equations)\\
	(also sparse system)
\end{frame}

\begin{frame}[fragile]
	\frametitle{The Perturbations Module}
	
	ODE Solver (customized for Einstein-Boltzmann equations)\\
	\mbox{}\\
	\begin{itemize}
		\item Stiff system require implicit method like backward Euler or more advanced:\\
		~~~~$\rightarrow$ find $\mathrm{y_{n+1}}$ as a solution of $\mathbf{y_{n+1}} = y_n + y'(\mathbf{y_{n+1}}) \delta t$
		\item Still fast: Newton method with Jacobian recycling 
		\item Robustness requires $\delta t$ to be adaptive time step
		\item Source function required at predefined $t_i$: on-the-fly interpolation
		\item System is sparse: some algebra gives big speed up (sparse LU decomposition)
	\end{itemize}
	Everything gathered in {\tt ndf15} by T. Tram (CLASS II 2011).\\ TCA could even be removed!
\end{frame}


\begin{frame}[fragile]
	\frametitle{The Perturbations Module}
	
	ODE approximations (papers : CLASS II \& CLASS IV 2011)\\
	
	Idea of these approximations: Reduce number of evolved equations.
	
	\begin{itemize}
		\item Tight Coupling Approximation for baryons and $\gamma$ at 2nd order $\rightarrow$ Suppresses shear \& higher moments whenever $k \tau_{b \gamma} \ll 1$
		\item Ultrarelativistic Fluid Approximation (for massless $\nu$, also one for massive ones): truncated Boltzmann, 3 equations $\rightarrow$ Suppresses higher order moments whenever $k \tau \gg 1$\\
		\item Radiation Streaming Approximation (for photons and massless $\nu$): test particles, 0 equations $\rightarrow$ Only follow oscillation-averaged evolution when $k \tau \gg \ell$ (+ for photons $k \tau_{b \gamma} \gg 1$)
	\end{itemize}
	
	\vspace*{-1\baselineskip}
	{\begin{flushright}
		\includegraphics[width=4cm,height=4cm,angle=0]{Figures/approx_summary.pdf}
	\end{flushright}}
	
\end{frame}



\begin{frame}[fragile]
\frametitle{The Perturbations Module}

Source functions \\
\mbox{}\\
\begin{itemize}
\item \scriptsize Keep memory not of everything, but anything useful for final calculation of observables: 
\begin{itemize}
\item \scriptsize raw transfer function ($\delta_m(\tau,k) \rightarrow P_m(k,z)$)
\item \scriptsize non-trivial combinations (photon, baryon, metric, thermodynamical functions $\rightarrow$ CMB source functions $S_{T_i}(k,\tau)$) 
\end{itemize}
All these are called {\it source functions} in {\Red \CLASS{}} 
\end{itemize}
{\begin{center}
\includegraphics[height=4cm,angle=0]{Figures/t0_lowres.jpg}
\end{center}}

\end{frame}


\begin{frame}[fragile]
\frametitle{The Perturbations Module}

Photon hierarchies\\
\mbox{}\\
Two approaches to polarization in Boltzmann hierarchy:
\begin{itemize}
	\item Ma \& Bertschinger 1994 (optimal):\\$(F_\ell, G_\ell) \rightarrow (S_T, S_P)  \rightarrow (\Delta_\ell^T, \Delta_\ell^E, \Delta_\ell^B)$: $2 \ell_{\rm max}$ equations, only flat!
	\item Hu \& White 1997 (TAM):\\$(\Theta_\ell, E_\ell, B_\ell) \rightarrow (S_T, S_E, S_B)  \rightarrow (\Delta_\ell^T, \Delta_\ell^E, \Delta_\ell^B)$: $3 \ell_{\rm max}$ equations!
\end{itemize}

\pause
\vspace{0.2cm}

{\Red CMBFAST}: first in flat space, second in curved space\\

\pause
\vspace{0.2cm}

{\Red CAMB}: always second case\\

\pause
\vspace{0.2cm}

{\Red \CLASS{}}: first case by default, thanks to new analytic results in curved space\\ \hfill (T. Tram \& JL, JCAP 2013 [arXiv:1305.3261], approximation!) \\
User can select second case


\end{frame}

\begin{frame}[fragile]
	\frametitle{Perturbations exercise}
Let's check this with an exercise!

Download the jupyter notebook \href{https://github.com/MarkMos/class_lecture/blob/main/notebooks/Exercise_perturbations_to_fill.ipynb}{Exercise\_perturbations\_to\_fill.ipynb} and follow the steps to plot the properties computed by the Perturbations module.


\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%% Primordial


\begin{frame}[fragile]
\frametitle{Essentials 5: Primordial}


\mbox{}\\
Initial conditions for scalars (adiabatic, isocurvature) and tensors. 
Linear theory $\Leftrightarrow$ Gaussian independent Fourier modes $\Leftrightarrow$ only power spectrum required
\begin{itemize}
\item analytic: primordial power spectra as parametric functions (e.g. power-law)
\item inflation mode: solve background+perturbation equation for single-field inflation and compute primordial scalar/tensor spectrum numerically
\end{itemize}
\mbox{ }\\
\begin{center}
	\includegraphics[height=4cm,angle=0]{Figures/iso.png}
	\includegraphics[height=4cm,angle=0]{Figures/pot.png}
\end{center}

\end{frame}


\begin{frame}[fragile]
\frametitle{The Primordial module}

{\bf Primordial spectra : modes}\\
\mbox{}\\
\begin{tabular}{|c|c|c|}
	\hline
	\cinline{P\_k\_ini type =} & \cinline{modes =} & \cinline{ic = } \\ \hline
	\hline
	\cinline{analytic\_Pk} & at least one: \cinline{s,t} & at least one: \cinline{ad,bi,cdi,nid,niv} \\
	\cinline{inflation\_V} & \cinline{s,t} & \cinline{ad} \\
	\cinline{inflation\_H} & \cinline{s,t} & \cinline{ad} \\
	\cinline{inflation\_V\_end} & \cinline{s,t} & \cinline{ad} \\ \hline
	\cinline{external\_Pk} & at least one: \cinline{s,t} & \cinline{ad} \\ \hline
\end{tabular}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%% Fourier


\begin{frame}[fragile]
\frametitle{Essentials 6: Fourier}


\mbox{}\\
\begin{itemize}
\item
Linear matter power spectrum $P_m(k,z)$ $\rightarrow$ integrated quantities $\sigma(R,z)$, $\sigma_8(z)$
\item
Linear baryon+CDM power spectrum $P_{cb}(k,z)$ $\rightarrow$ integrated quantities $\sigma_{cb,8}(z)$
\item
Approximation for non-linear spectrum $P^{NL}_m(k,z)$ based on prescriptions like {\Purple Halofit}, {\Purple HMcode}...
\item
Keep also non-linear correction factor $\left(R^{NL}(k,z)\right)^2 = P^{NL}_m(k,z) / P_m(k,z)$ for e.g., CMB lensing, cosmic shear, number count $C_{\ell}$'s
\end{itemize}
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\includegraphics[width=5cm,angle=0]{Figures/plot2}

\end{frame}


\begin{frame}[fragile]
\frametitle{The Fourier Module}

{\bf How to emulate non-linear evolution with a halo model?}\\
\mbox{}\\
{\Purple Halofit} or {\Purple HMcode} require non-linearity scale $R_\mathrm{NL}(z)$ such that $\sigma(R_\mathrm{NL}(z), z)=1$.\\
\begin{center}
\includegraphics[width=8cm,angle=0]{Figures/Halofit_zmax.pdf}\\	
\end{center}
To get $P^{\rm NL}(k,z)$ ar higher $z$ one should increase $k_{\rm max}$.

\end{frame}

\begin{frame}[fragile]
	\frametitle{The Fourier Module}

	\mbox{}\\
	{\Purple Halofit} relies on simple similarity solution Ansatz:
	
	$\Delta^2_\mathrm{1-halo}(k) = \underbrace{\frac{a_n y^{3 f_2}}{(1+b_n y^{f_2}+(f_3 c_n y)^{3-\gamma_n}}}_{\text{Original term, corrected with~}f_2} \underbrace{\frac{1}{(1+x_\mu y^{-1}+x_\nu y^{-2}) (1+0.977 f_\nu)}}_{\text{Further corrections}}$\\
	
	with $y = k/k_\mathrm{nl} = k R_\mathrm{NL}(z)$. \\
	Parameters calibrated to fit (early) simulations reasonably well. \\ \mbox{}\\
	
	$\Delta^2_\mathrm{nl} \approx \Delta^2_\mathrm{2-halo} +  \Delta^2_\mathrm{1-halo}$ with $\Delta^2_\mathrm{2-halo} \approx \frac{(1+\Delta^2_\mathrm{lin})^\beta}{(1+\alpha \Delta^2_\mathrm{lin})} \cdot \exp\left(-y/4-y^2/8\right)$
	with $\Delta^2_\mathrm{lin} = P_\mathrm{lin}(k,z) \frac{k^3}{2\pi^2}$
	
	\mbox{} \\ \mbox{} \\ 
	{\bf Summary: Simple analytical fitting formula} 
\end{frame}



\begin{frame}[fragile]
	\frametitle{The Fourier Module}

	{\Purple HMcode} has a more complicated halo model:
	\begin{itemize}
		\item $\Delta^2_\mathrm{nl} \approx \left(\left(\Delta^2_\mathrm{2-halo}\right)^\alpha +  \left(\Delta^2_\mathrm{1-halo}\right)^\alpha\right)^{1/\alpha}$
		\item $P_\mathrm{2-halo} = \left[P_\mathrm{lin} + (f_\mathrm{dewiggle}-1.) P_\mathrm{BAO-wiggle}\right] \times \{1-f_\mathrm{damp} \cdot (k/k_\mathrm{damp})^{\alpha_\mathrm{damp}}/[1+(k/k_\mathrm{damp})^{\alpha_\mathrm{damp}}]\}$
		\item $P_\mathrm{1-halo} = \int n(\nu k^\eta) g(\nu) \mathrm{d}m$
		\item  $\nu = \delta_c/\sigma(R(m))$
		\item $g(\nu) = A \cdot (1+(q \nu^2)^{-p}) \exp(-q \nu^2/2)$ Sheth-Tormen HMF
		\item $n(x) = $ NFW halo profile
	\end{itemize}
	
	\mbox{} \\ \mbox{} \\ 
	{\bf Summary: Physically motivated halo formula, reproduces well current simulations} 
\end{frame}

\begin{frame}[fragile]
	\frametitle{Fourier exercise}
Let's check this with an exercise!

Download the jupyter notebook \href{https://github.com/MarkMos/class_lecture/blob/main/notebooks/Exercise_fourier_to_fill.ipynb}{Exercise\_fourier\_to\_fill.ipynb} and follow the steps to plot the properties computed by the Fourier module.


\end{frame}

%%%%%%%%%%%%%%%%%%%% Transfer + Harmonic


\begin{frame}[fragile]
	\frametitle{Essentials 7+8: Transfer \& Harmonic}
	
	\begin{columns}[T] % align columns
	\begin{column}{0.56\textwidth}
		\begin{center}
			$\delta(k,\tau), \theta(k,\tau)$ (perturbations)\\
			$\downarrow$ \\
			$S^\mathrm{cmb}(k,\tau), S^{m}(k,\tau)$ (source functions)\\
			$\downarrow$ \\
			$\downarrow$ \\
			$\downarrow$ \\
			$\downarrow$ \\
			$\downarrow$ \\
			$\downarrow$ \\
			$\downarrow$ \\
			$\downarrow$ \\
			$\Delta^x_\ell(k)$ (line-of-sight projection, {\bf \tt transfer.c})\\
			$\downarrow$ \\
			$\downarrow$ \\
			$\downarrow$ \\
			$\downarrow$ \\
			$\int \Delta^x_\ell(k) \Delta^y_\ell(k) \mathrm{d}\ln k$ \\ (correlation and summation, {\bf \tt harmonic.c})
		\end{center}
	\end{column}
	\begin{column}{0.4\textwidth}
		\includegraphics[height=0.75\textheight]{Figures/projection}
	\end{column}
	\end{columns}
\end{frame}

\begin{frame}[fragile]
\frametitle{Transfer \& Harmonic Modules}

CMB spectrum depends on $\Delta^X_\ell(k)=$ $\ell$-th multipole of anisotropy of photon temperature and polarisation ($X\in\{T,E,B\}$) today ($\tau=\tau_0$).
\\
\mbox{}\\
Since {\Red \tt CMBFAST}(Seljak \& Zaldarriaga 1996): use ``line-of-sight integral''
$$
\Delta^X_\ell(k)= \int_\epsilon^{\tau_0} d \tau \,\, S^X\!(\tau,k) \,\, j_\ell(k(\tau_0-\tau))
$$
$S(\tau,k)$ = source function from above.
Role of Bessel: projection from Fourier to harmonic space ($\theta \, d_a(z_\mathrm{rec}) = \frac{\lambda}{2}$ gives precisely $l=k(\tau_0-\tau_\mathrm{rec})$):\\
\begin{center}
	\includegraphics[width=5cm,angle=0]{Figures/smallangle.png}\\
\end{center}
Curved space: spherical bessel functions $\rightarrow$ modified Bessel functions (hypergeometric)
\end{frame}

\begin{frame}[fragile]
\frametitle{Transfer \& Harmonic Modules}
$$
\Delta^X_\ell(k)= \int_\epsilon^{\tau_0} d \tau \,\, S^X\!(\tau,k) \,\, j_l(k(\tau_0-\tau))
$$
applies not just to CMB $X\in\{T,E,B\}$ but also all LSS $C_\ell$'s (one $X$ per type of observable and redshift bin).
\begin{itemize}
\item CMB lensing + cosmic shear: ($S(\tau,k)$ involves broad window function)
\item number count (galaxy clustering): $S(\tau,k)$ modeled fully relativistically (RSD, Doppler, lensing, other GR effects) 
\item may include non-linear correction factors $R^{NL}(k,z)$
\end{itemize}

\end{frame}  





\begin{frame}[fragile]
\frametitle{Transfer \& Harmonic Modules}

Well known
$$\Delta_\ell (k) = \int_{\epsilon}^{\tau_0} d \tau \,\, S_T(\tau,k) \,\, j_\ell(k(\tau_0-\tau))$$
$${\rm with}~~~S_T(\tau,k) \equiv \mathop{\underbrace{g\left(\Theta_0 + \psi\right)}}_\mathrm{SW} 
+ \mathop{\underbrace{\left(g \, k^{-2} \theta_\mathrm{b}\right)'}}_\mathrm{Doppler}  
+ \mathop{\underbrace{e^{-\kappa} (\phi'+\psi')}}_\mathrm{ISW} + \, \mathrm{polarisation}~$$
comes from integration by part of:
\begin{eqnarray}
\Delta_l (k) = \int_{\tau_\mathrm{ini}}^{\tau_0} d \tau \!\!\!\!\!\!\!\!\!\!\!\!&& \left\{  S_T^0(\tau,k) \,\, j_l(k(\tau_0-\tau))\right. \nonumber \\
&& + S_T^1(\tau,k) \,\, \frac{d j_l}{dx}(k(\tau_0-\tau)) \nonumber \\
&&\left. + S_T^2(\tau,k) \,\, \frac{1}{2}\left[3 \frac{d^2 j_l}{dx^2}(k(\tau_0-\tau)) + j_l(k(\tau_0-\tau)) \right]\right\} \nonumber
\end{eqnarray}
But $(S_T^1)'$, $(S_T^2)'$, $(S_T^2)''$ problematic! (Derivative of Einstein equation, massive neutrinos $\rightarrow$ finite differences...)

\end{frame}


\begin{frame}[fragile]
\frametitle{Transfer \& Harmonic Modules}

So we should rather stick to
\begin{eqnarray}
\Delta_l (k) = \int_{\tau_\mathrm{ini}}^{\tau_0} d \tau \!\!\!\!\!\!\!\!\!\!\!\!&& \left\{  S_T^0(\tau,k) \,\, j_l(k(\tau_0-\tau))\right. \nonumber \\
&& + S_T^1(\tau,k) \,\, \frac{d j_l}{dx}(k(\tau_0-\tau)) \nonumber \\
&&\left. + S_T^2(\tau,k) \,\, \frac{1}{2}\left[3 \frac{d^2 j_l}{dx^2}(k(\tau_0-\tau)) + j_l(k(\tau_0-\tau)) \right]\right\} \nonumber
\end{eqnarray}
CLASS v2.0 stores separately  $S_T^0(\tau,k)$, $S_T^1(\tau,k)$, $S_T^2(\tau,k)$, and the transfer module will convolve them individually with respective bessel functions.
$$
S_T^0 = g \left(\frac{\delta_g}{4} +\psi \right) + e^{-\kappa} (\phi' + \psi') \qquad
S_T^1 = g \frac{\theta_b}{k}\qquad
S_T^2 = \frac{g}{8} \left( G_0 + G_2 + F_2 \right) 
$$
or
$$
S_T^0 = g \left(\frac{\delta_g}{4} +\phi \right) + e^{-\kappa} 2 \phi'  + g'\theta_b + g \theta_b' \qquad
S_T^1 = e^{-\kappa} k (\psi-\phi) \qquad
S_T^2 = \frac{g}{8} \left( G_0 + G_2 + F_2 \right) 
$$

\end{frame}

\begin{frame}[fragile]
\frametitle{Transfer \& Harmonic Modules}

Last step is (almost) trivial:
$$
C_\ell^{XY} = \int \frac{dk}{k}  \sum_{ij}  \Delta^X_{\ell \, i}(k)  \Delta^Y_{\ell \, j}(k) {\cal P}_{ij}(k)  
$$
with sum running over modes (scalar/tensor) and I.C. (adiabatic/isocurvature).\\
\mbox{} \\
\begin{center}
\includegraphics[width=7cm,angle=0]{Figures/cl_ST.pdf}
\end{center}

\end{frame}

\begin{frame}[fragile]
	\frametitle{Harmonic exercise}
Let's check this with an exercise!

Download the jupyter notebook \href{https://github.com/MarkMos/class_lecture/blob/main/notebooks/Exercise_harmonic_to_fill.ipynb}{Exercise\_harmonic\_to\_fill.ipynb} and follow the steps to plot the properties computed by the Harmonic module.


\end{frame}

\begin{frame}[fragile]
\frametitle{Essentials 9: Lensing}

\mbox{}\\
\begin{itemize}
\item
metric fluctuations $(\phi, \psi)$ $\rightarrow$ lensing potential source function $\rightarrow$ CMB lensing potential spectrum $C_\ell^{PP}$\\
\item
several quadratic sums over $C_{\ell_1}^{XY} C_{\ell_2}^{PP}$  $\rightarrow$ lensed CMB spectra $C_\ell^{TT,TE,EE,BB}$. Full-sky approach of Challinor \& Lewis 2005.
\end{itemize}
\begin{center}
	\includegraphics[width=7cm,angle=0]{Figures/cltt_terms.pdf}
\end{center}

\end{frame}



\begin{frame}[fragile]
	\frametitle{Essentials 10: Spectral Distortions}

	\begin{itemize}
		\item
		Computations using \texttt{CosmoTherm} to derive thermalization Green's function
		\item Using Green's function to compute $\mu,y$ amplitudes
	\end{itemize}

	\mbox{}\\
	Simplified view:
	\begin{equation}
		a = \int \dot{Q} J_a(t) dt
	\end{equation}
	with branching function $J_a(t)$.\\[1ex]

	\begin{center}
	\includegraphics[width=0.6\textwidth]{Figures/br_pca_edited.pdf}
	\end{center}
	
\end{frame}




\begin{frame}[fragile]
	\frametitle{Essentials 11: Output}
	\mbox{}\\
	Writes output files with correct headers and data.\\
	If you are ever in doubt about \CLASS{} output units, check the headers of an output file.
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Implementing Features


\begin{frame}[fragile]
\frametitle{Implementing new features}

If you want to implement:
\begin{itemize}
\item a new species
\item a new approximation scheme to simplify some equations in some regime
\item a new mathematical description of an existing species (switching on more precise corrections, etc.)
\item a new observable or output (new source function, new transfer function, new spectrum...)
\end{itemize}
the logic is always the same:
\pause
\begin{enumerate}
\item define an acronym easy to search in the C files (e.g. for early dark energy: \cinline{earde} is good, \cinline{ede} is bad because it is inside ``redefine'', ``needed'', etc.)
\pause
\item think of the feature closest to yours, and find its acronym (e.g. for fluid: \cinline{fld})
\pause
\item grep for all occurences of \cinline{fld} in {\tt  include/*.h} and {\tt source/*.c} (normally they are all within some ``\cinline{if (has_fld) \{ ...\}}'' and you can search directly for occurences of \cinline{has_fld})
\pause
\item duplicate these occurences
\pause
\item change \cinline{fld} into \cinline{earde} 
\pause
\item change some equations to describe the specific properties of your feature
\end{enumerate}
\end{frame}



\end{document}
